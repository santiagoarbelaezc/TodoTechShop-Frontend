<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Caja - TodoTech</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="caja.component.css" />

  
</head>
<body>
  <div class="overlay"></div>
  
  <!-- Navbar -->
  <app-navbar-caja 
    (seccionCambiada)="onSeccionCambiada($event)"
    [seccionActiva]="seccionActiva">
  </app-navbar-caja>

  <!-- Sistema de Mensajes -->
  <div *ngIf="successMessage" class="mensaje-exito">
    <i class="fas fa-check-circle"></i>
    <div class="mensaje-contenido">
      <div class="mensaje-titulo">¡Éxito!</div>
      <div class="mensaje-texto">{{ successMessage }}</div>
    </div>
  </div>

  <div *ngIf="errorMessage" class="mensaje-error">
    <i class="fas fa-exclamation-circle"></i>
    <div class="mensaje-contenido">
      <div class="mensaje-titulo">Error</div>
      <div class="mensaje-texto">{{ errorMessage }}</div>
    </div>
  </div>

  <div *ngIf="cargando" class="mensaje-carga">
    <i class="fas fa-spinner fa-spin"></i>
    <div class="mensaje-contenido">
      <div class="mensaje-titulo">Procesando</div>
      <div class="mensaje-texto">Procesando pago...</div>
    </div>
  </div>

  <!-- Contenido Principal -->
  <main class="caja-container">
    
    <!-- Header de la página -->
    <header class="page-header">
      <div class="header-main">
        <div class="header-content">
          <h1 class="page-title">
            <i class="fas fa-cash-register"></i>
            Sistema de Caja
          </h1>
          <p class="page-subtitle">Procesa pagos de órdenes de venta - Cajero: {{currentOrderDetails.seller}}</p>
        </div>
        
        <!-- Estadísticas -->
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-receipt"></i>
            </div>
            <div class="stat-info">
              <span class="stat-number">{{ totalOrdenes }}</span>
              <span class="stat-label">Total Órdenes</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon pendientes">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
              <span class="stat-number">{{ ordenesPendientes }}</span>
              <span class="stat-label">Pendientes Pago</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon completadas">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
              <span class="stat-number">{{ ordenesPagadas }}</span>
              <span class="stat-label">Pagadas Hoy</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel de Órdenes -->
      <div class="ordenes-header-panel">
        <div class="panel-header">
          <h3>
            <i class="fas fa-list-ol"></i>
            Órdenes Pendientes de Pago
          </h3>
          <span class="badge-count">{{ordenes.length}}</span>
        </div>
        
        <div class="ordenes-list">
          <div *ngFor="let orden of ordenes" 
               class="orden-card"
               [class.selected]="orden.id === ordenSeleccionada?.id"
               (click)="seleccionarOrden(orden)">
            
            <div class="orden-header">
              <span class="orden-numero">#{{orden.numeroOrden}}</span>
              <span class="orden-estado" [class]="'estado-' + orden.estado.toLowerCase()">
                {{orden.estado}}
              </span>
            </div>
            
            <div class="orden-cliente-info">
              <i class="fas fa-user"></i>
              <span class="cliente-nombre">{{orden.cliente.nombre}}</span>
            </div>
            
            <div class="orden-total">
              <span class="total-label">Total:</span>
              <span class="total-value">{{orden.total | currency:'COP':'symbol':'1.0-0'}}</span>
            </div>
          </div>
          
          <div *ngIf="ordenes.length === 0" class="no-ordenes">
            <i class="fas fa-shopping-cart"></i>
            <p>No hay órdenes pendientes de pago</p>
          </div>
        </div>
      </div>
    </header>
<!-- Sección para Imprimir Orden Pagada -->
<section class="imprimir-section" *ngIf="ultimaOrdenPagada">
  <div class="panel-header">
    <h3>
      <i class="fas fa-receipt"></i>
      Orden Pagada Recientemente
    </h3>
    <span class="badge-success">PAGADA</span>
  </div>
  
  <div class="imprimir-content">
    <div class="orden-pagada-info">
      <div class="orden-pagada-header">
        <i class="fas fa-check-circle"></i>
        <div class="orden-pagada-details">
          <h4>Orden #{{ultimaOrdenPagada}} Pagada Exitosamente</h4>
        </div>
      </div>
      
      <div class="imprimir-actions">
        <button type="button" class="btn btn-imprimir" (click)="imprimirOrdenPagada()">
          <i class="fas fa-print"></i>
          Imprimir Comprobante
        </button>
        <button type="button" class="btn btn-email" (click)="enviarEmailOrden()">
          <i class="fas fa-envelope"></i>
          Enviar por Email
        </button>
        <button type="button" class="btn btn-limpiar" (click)="limpiarOrdenPagada()">
          <i class="fas fa-times"></i>
          Cerrar
        </button>
      </div>
    </div>
  </div>
</section>

    <!-- Panel Principal: Detalles y Pago -->
    <section class="pago-panel">
      <div class="panel-header">
        <h3>
          <i class="fas fa-credit-card"></i>
          Procesar Pago
        </h3>
        <div class="orden-info" *ngIf="ordenSeleccionada">
          <span class="orden-id">Orden #{{ordenSeleccionada.numeroOrden}}</span>
          <span class="orden-status" [class]="'status-' + ordenSeleccionada.estado.toLowerCase()">
            {{ordenSeleccionada.estado}}
          </span>
        </div>
      </div>

      <div class="pago-content" *ngIf="ordenSeleccionada; else noOrdenSelected">
        <div class="pago-grid">
          <!-- Columna Izquierda: Información de la Orden -->
          <div class="pago-col izquierda">
            <!-- Información de la Orden -->
            <div class="info-section">
    <h4 class="section-title">
        <i class="fas fa-info-circle"></i>
        Información de la Orden
    </h4>
    
    <!-- Información de la orden -->
    <div class="info-subsection">
        <h5 class="subsection-title">
            <i class="fas fa-receipt"></i>
            Datos de la Orden
        </h5>
        <div class="info-grid">
            <div class="info-item">
                <label>Número de Orden:</label>
                <span class="cliente-dato">{{ordenSeleccionada.numeroOrden}}</span>
            </div>
            <div class="info-item">
                <label>Fecha:</label>
                <span class="cliente-dato">{{ordenSeleccionada.fecha | date:'dd/MM/yyyy'}}</span>
            </div>
            
            <div class="info-item">
                <label>Vendedor:</label>
                <span class="cliente-dato">{{ordenSeleccionada.vendedor.nombre}}</span>
            </div>
        </div>
    </div>

    <!-- Información del cliente -->
    <div class="info-subsection">
        <h5 class="subsection-title">
            <i class="fas fa-user"></i>
            Datos del Cliente
        </h5>
        <div class="info-grid">
            <div class="info-item">
                <label>Nombre:</label>
                <span class="cliente-dato">{{ordenSeleccionada.cliente.nombre}}</span>
            </div>
            <div class="info-item">
                <label>Cédula/NIT:</label>
                <span class="cliente-dato">{{ordenSeleccionada.cliente.cedula}}</span>
            </div>
            <div class="info-item">
                <label>Tipo de Cliente:</label>
                <span class="cliente-dato">{{ordenSeleccionada.cliente.tipoCliente === 'NATURAL' ? 'Natural' : 'Jurídico'}}</span>
            </div>
            
            <div class="info-item" *ngIf="ordenSeleccionada.cliente.correo">
                <label>Email:</label>
                <span class="cliente-dato">{{ordenSeleccionada.cliente.correo}}</span>
            </div>
            <div class="info-item" *ngIf="ordenSeleccionada.cliente.telefono">
                <label>Teléfono:</label>
                <span class="cliente-dato">{{ordenSeleccionada.cliente.telefono}}</span>
            </div>
            <div class="info-item" *ngIf="ordenSeleccionada.cliente.direccion">
                <label>Dirección:</label>
                <span class="cliente-dato">{{ordenSeleccionada.cliente.direccion}}</span>
            </div>
            
        </div>
    </div>

    <!-- Observaciones -->
    <div class="info-subsection" *ngIf="ordenSeleccionada.observaciones">
        <h5 class="subsection-title">
            <i class="fas fa-sticky-note"></i>
            Observaciones
        </h5>
        <div class="info-grid">
            <div class="info-item">
                <span class="cliente-dato">{{ordenSeleccionada.observaciones}}</span>
            </div>
        </div>
    </div>
</div>       
            
          </div>

          <!-- Columna Derecha: Totales y Métodos de Pago -->
          <div class="pago-col derecha">
            <!-- Resumen de Totales -->
            <div class="totales-section">
              <h4 class="section-title">
                <i class="fas fa-calculator"></i>
                Resumen de Totales
              </h4>
              <div class="totales-grid">
                <div class="total-item">
                  <span>Subtotal:</span>
                  <span>{{ordenSeleccionada.subtotal | currency:'COP':'symbol':'1.0-0'}}</span>
                </div>
                <div class="total-item">
                    <span>Descuento ({{ordenSeleccionada.cliente.descuentoAplicable || 0}}%):</span>
                    <span class="descuento">{{ordenSeleccionada.cliente.descuentoAplicable || 0}}%</span>
                </div>
                <div class="total-item">
                  <span>IVA (19%):</span>
                  <span>{{ordenSeleccionada.impuestos | currency:'COP':'symbol':'1.0-0'}}</span>
                </div>
                <div class="total-item total-final">
                  <span>TOTAL A PAGAR:</span>
                  <span class="total-pagar">{{ordenSeleccionada.total | currency:'COP':'symbol':'1.0-0'}}</span>
                </div>

                <!-- Información de conversión para Stripe -->
                <div *ngIf="esMetodoStripe()" class="conversion-info">
                  <div class="conversion-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>El monto se convertirá automáticamente a USD al procesar el pago</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Métodos de Pago -->
            <div class="metodos-pago-section">
              <h4 class="section-title">
                <i class="fas fa-credit-card"></i>
                Método de Pago
              </h4>
              
              <div class="metodos-pago-grid">
                <div class="metodo-pago-card" 
                     *ngFor="let metodo of metodosPago"
                     (click)="selectPaymentMethod(metodo.nombre)"
                     [class.active]="selectedPaymentMethod === metodo.nombre"
                     [class.stripe-method]="metodo.tipoMetodo === 'STRIPE'">
                  <img [src]="metodo.icono" [alt]="metodo.nombre" class="metodo-icon" />
                  <span class="metodo-nombre">{{ metodo.nombre }}</span>
                  <span *ngIf="metodo.tipoMetodo === 'STRIPE'" class="stripe-badge">
                    <i class="fas fa-shield-alt"></i>
                    Seguro
                  </span>
                </div>
              </div>

              <!-- Información de Stripe -->
              <div *ngIf="esMetodoStripe()" class="stripe-info-section">
                <div class="stripe-info-message">
                  <i class="fas fa-shield-alt"></i>
                  <div class="stripe-info-content">
                    <strong>Pago seguro con Stripe</strong>
                    <p>Será redirigido a Stripe para completar el pago de forma segura. El monto en COP se convertirá automáticamente a USD.</p>
                  </div>
                </div>

                <div class="stripe-features">
                  <div class="stripe-feature">
                    <i class="fas fa-lock"></i>
                    <span>Protegido con encriptación SSL</span>
                  </div>
                  <div class="stripe-feature">
                    <i class="fas fa-credit-card"></i>
                    <span>Datos de tarjeta seguros</span>
                  </div>
                  <div class="stripe-feature">
                    <i class="fas fa-globe"></i>
                    <span>Conversión automática a USD</span>
                  </div>
                </div>
              </div>

              <!-- Formulario de Efectivo -->
              <div class="cash-form" *ngIf="selectedPaymentMethod === 'Efectivo'">
                <div class="cash-input-group">
                  <label for="cashAmount" class="cash-label">
                    <i class="fas fa-money-bill-wave"></i>
                    Efectivo Recibido:
                  </label>
                  <input
                    type="number"
                    id="cashAmount"
                    name="cashAmount"
                    [(ngModel)]="cashAmount"
                    (input)="calculateChange()"
                    min="0"
                    placeholder="0"
                    class="cash-input" />
                </div>

                <!-- Resumen de Cambio -->
                <div class="cambio-section" *ngIf="cashAmount > 0">
                  <div class="cambio-item">
                    <span>Total a Pagar:</span>
                    <span>{{ordenSeleccionada.total | currency:'COP':'symbol':'1.0-0'}}</span>
                  </div>
                  <div class="cambio-item">
                    <span>Efectivo Recibido:</span>
                    <span>{{cashAmount | currency:'COP':'symbol':'1.0-0'}}</span>
                  </div>
                  <div class="cambio-item cambio-total" [class.negativo]="changeAmount < 0">
                    <span>Cambio:</span>
                    <span>{{changeAmount | currency:'COP':'symbol':'1.0-0'}}</span>
                  </div>
                  
                  <div class="alerta-cambio" *ngIf="changeAmount < 0">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>¡Faltan {{(-changeAmount) | currency:'COP':'symbol':'1.0-0'}}!</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de Acción -->
        <div class="acciones-pago">
          <button type="button" (click)="cancelOrder()" class="btn btn-cancelar" [disabled]="cargando">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button type="button" (click)="processPayment()" class="btn btn-pagar" 
                  [disabled]="!puedeProcesarPago() || cargando"
                  [class.processing]="cargando">
            <i class="fas fa-credit-card" *ngIf="!cargando"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="cargando"></i>
            
            <span *ngIf="cargando">Procesando...</span>
            <span *ngIf="!cargando">
              {{ esMetodoStripe() ? 'Pagar con Stripe' : 'Procesar Pago' }}
            </span>
            
            <span *ngIf="ordenSeleccionada" class="total-btn">
              {{ordenSeleccionada.total | currency:'COP':'symbol':'1.0-0'}}
            </span>
          </button>
        </div>
      </div>

      <ng-template #noOrdenSelected>
        <div class="no-orden-selected">
          <i class="fas fa-hand-holding-usd"></i>
          <h3>Seleccione una orden</h3>
          <p>Elija una orden de la lista para procesar el pago</p>
        </div>
      </ng-template>
    </section>

    <!-- Modal para Pago en Efectivo -->
<div class="modal-overlay" *ngIf="showCashModal" (click)="closeCashModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-money-bill-wave"></i>
        Pago en Efectivo
      </h3>
      <button class="modal-close" (click)="closeCashModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-content">
      <!-- Información de la orden -->
      <div class="order-summary">
        <div class="summary-item">
          <span>Orden:</span>
          <strong>#{{ordenSeleccionada?.numeroOrden}}</strong>
        </div>
        <div class="summary-item">
          <span>Cliente:</span>
          <span>{{ordenSeleccionada?.cliente?.nombre}}</span>
        </div>
        <div class="summary-item total-due">
          <span>Total a Pagar:</span>
          <strong class="total-amount">{{ordenSeleccionada?.total | currency:'COP':'symbol':'1.0-0'}}</strong>
        </div>
      </div>

      <!-- Input para el monto recibido -->
      <div class="cash-input-section">
        <label for="cashReceived" class="cash-input-label">
          <i class="fas fa-hand-holding-usd"></i>
          Efectivo Recibido:
        </label>
        <input
          type="number"
          id="cashReceived"
          [(ngModel)]="cashReceived"
          (input)="calculateChange()"
          placeholder="0"
          min="0"
          class="cash-input"
          autofocus
        />
      </div>

      <!-- Resumen del cambio -->
      <div class="change-summary" *ngIf="cashReceived > 0">
        <div class="change-item">
          <span>Total a Pagar:</span>
          <span>{{ordenSeleccionada?.total | currency:'COP':'symbol':'1.0-0'}}</span>
        </div>
        <div class="change-item">
          <span>Efectivo Recibido:</span>
          <span>{{cashReceived | currency:'COP':'symbol':'1.0-0'}}</span>
        </div>
        <div class="change-item change-total" [class.insufficient]="changeAmount < 0" [class.sufficient]="changeAmount >= 0">
          <span>{{changeAmount >= 0 ? 'Cambio a Devolver:' : 'Falta:'}}</span>
          <strong>{{changeAmount | currency:'COP':'symbol':'1.0-0'}}</strong>
        </div>

        <!-- Alertas -->
        <div class="alert-message" *ngIf="changeAmount < 0">
          <i class="fas fa-exclamation-triangle"></i>
          <span>El monto recibido es insuficiente. Faltan {{(-changeAmount) | currency:'COP':'symbol':'1.0-0'}}</span>
        </div>

        <div class="alert-message success" *ngIf="changeAmount >= 0 && changeAmount > 0">
          <i class="fas fa-check-circle"></i>
          <span>Cambio calculado correctamente</span>
        </div>

        <div class="alert-message exact" *ngIf="changeAmount === 0">
          <i class="fas fa-check"></i>
          <span>Pago exacto, no hay cambio</span>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn btn-cancel" (click)="closeCashModal()">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button 
        type="button" 
        class="btn btn-confirm" 
        (click)="confirmCashPayment()"
        [disabled]="!canConfirmCashPayment()"
        [class.disabled]="!canConfirmCashPayment()">
        <i class="fas fa-check-circle"></i>
        Confirmar Pago
      </button>
    </div>
  </div>
</div>
  </main>
</body>
</html>